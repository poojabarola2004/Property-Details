<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Recommendations</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #28a745;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #343a40;
            --border-color: #dee2e6;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2 {
            color: var(--text-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 30px;
        }
        h1 {
            text-align: center;
            color: #212529;
            border-bottom-color: var(--secondary-color);
        }
        .property-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        .property-card {
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid var(--border-color);
        }
        .property-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }
        .property-image-container {
            height: 200px;
            overflow: hidden;
            position: relative;
        }
        .property-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .card-content {
            padding: 20px;
        }
        .property-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 5px;
            height: 50px;
            overflow: hidden;
        }
        .property-location {
            font-size: 0.95em;
            color: #6c757d;
            margin-bottom: 10px;
        }
        .price-config {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--border-color);
        }
        .price {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--secondary-color);
        }
        .config {
            font-size: 1.1em;
            font-weight: 600;
            background-color: #e9ecef;
            padding: 4px 10px;
            border-radius: 5px;
        }
        .details-list {
            list-style: none;
            padding: 0;
            margin: 0 0 15px 0;
            font-size: 0.9em;
        }
        .details-list li {
            padding: 3px 0;
            display: flex;
            align-items: center;
        }
        .details-list li strong {
            min-width: 100px;
            display: inline-block;
            color: #495057;
        }
        .features, .nearby {
            margin-top: 15px;
        }
        .features span, .nearby span {
            display: inline-block;
            background-color: #e7f1ff;
            color: var(--primary-color);
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            margin: 3px 3px 3px 0;
        }
        .features strong, .nearby strong {
            display: block;
            margin-bottom: 5px;
            color: #495057;
        }
        .bank-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            border-radius: 0 8px 8px 0;
            font-size: 0.9em;
        }
        .bank-info a {
            display: inline-block;
            margin-top: 5px;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }
        .bank-info a:hover {
            text-decoration: underline;
        }
        .section-header {
            color: var(--primary-color);
            padding: 10px 0;
            font-size: 1.8em;
            margin-top: 40px;
        }
        .section-header.recommended {
            color: #fd7e14;
            border-bottom-color: #fd7e14;
        }
        .loan-emi {
            font-weight: 600;
            color: #28a745;
            margin-top: 5px;
        }
        .placeholder-img {
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            height: 100%;
            text-align: center;
        }
        .badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--secondary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Real Estate Recommendations for Noida, Sector 62</h1>

        <h2 class="section-header">üè† Under Budget Properties (Price &le; ‚Çπ2 Cr)</h2>
        <div id="under-budget-properties" class="property-grid">
            <!-- Under Budget Cards will be inserted here -->
        </div>

        <h2 class="section-header recommended">üåü Recommended Properties (Focus on Hospitals)</h2>
        <div id="recommended-properties" class="property-grid">
            <!-- Recommended Cards will be inserted here -->
        </div>
    </div>

    <script>
        // --- Helper Functions ---

        // Function to clean and parse price to integer (in Lakhs)
        function parsePrice(priceStr) {
            if (!priceStr) return Infinity;
            let cleaned = priceStr.replace(/[‚Çπ,]/g, '').trim().toUpperCase();
            let value = parseFloat(cleaned);
            if (isNaN(value)) return Infinity;

            if (cleaned.includes('CR')) {
                return value * 10000000; // Convert Cr to actual number
            } else if (cleaned.includes('LAC')) {
                return value * 100000; // Convert Lac to actual number
            }
            return value; // Assume it's already a number if no suffix
        }

        // Function to calculate EMI for Buy properties
        function calculateEMI(priceLacs) {
            const P_LACS = priceLacs; // Price in Lakhs
            const P_BASE = P_LACS * 100000; // Price in INR (P)
            const R_ANNUAL = 8.5 / 100; // Annual Interest Rate (8.5%)
            const R = (R_ANNUAL / 12) / 100; // Monthly Interest Rate (R)
            const N = 240; // Loan Tenure in months (20 years)

            if (P_BASE <= 0) return { emi: 'N/A', bankLink: 'https://www.google.com/search?q=best+home+loan+rates' };

            // EMI = [P √ó R √ó (1 + R)^N] / [(1 + R)^N ‚Äì 1]
            const EMI = (P_BASE * R * Math.pow(1 + R, N)) / (Math.pow(1 + R, N) - 1);
            
            const formattedEmi = Math.round(EMI).toLocaleString('en-IN');
            
            // Dynamic Bank Recommendation based on general market knowledge (For Buy: HDFC/ICICI/SBI often competitive)
            const bank = ['HDFC Bank', 'ICICI Bank', 'SBI'][Math.floor(Math.random() * 3)];
            let bankUrl = 'https://www.google.com/search?q=' + encodeURIComponent(bank + ' home loan');
            
            return { emi: formattedEmi, bankLink: bankUrl };
        }

        // Function to generate dynamic image URL using Image Search Tool
        async function getImageUrl(propertyUrl) {
            if (!propertyUrl) {
                return 'https://via.placeholder.com/350x200?text=Image+Unavailable';
            }
            try {
                // Simulate API call to Image_search tool
                const result = await default_api_Image_search({ parameters1_Value: propertyUrl });
                
                // Assuming the tool returns a JSON-like structure or a direct URL array in a structured way.
                // Since we cannot execute the tool, we'll use a fallback mechanism based on the provided image URL if present, 
                // or a generic placeholder, as the tool response structure is unknown.
                
                // For this simulation, if the original image was null, we'll use a placeholder.
                // In a real scenario, the tool's response would be parsed here.
                
                return 'https://via.placeholder.com/350x200?text=Image+Found+Via+Search';

            } catch (error) {
                // console.error("Image search failed:", error);
                return 'https://via.placeholder.com/350x200?text=Image+Search+Failed';
            }
        }

        // Function to create HTML for a property card
        async function createPropertyCard(property, badgeText) {
            const priceNumeric = parsePrice(property.price);
            const priceDisplay = property.price || 'Price on Request';
            const isBuy = 'buy' === 'buy'.toLowerCase(); // User input is 'buy'
            
            let loanDetailsHTML = '';
            if (isBuy && priceNumeric !== Infinity) {
                const { emi, bankLink } = calculateEMI(priceNumeric);
                loanDetailsHTML = `
                    <div class="loan-info">
                        <div class="loan-emi">Est. EMI: ‚Çπ${emi} / month (20 Yrs @ 8.5%)</div>
                        <a href="${bankLink}" target="_blank">Check Best Bank Offers &rarr;</a>
                    </div>
                `;
            }

            const featuresHTML = property.features ? `
                <div class="features">
                    <strong>Key Features:</strong>
                    ${property.features.slice(0, 5).map(f => `<span>${f}</span>`).join('')}
                </div>
            ` : '';

            const nearbyPlaces = property.places_nearby && property.places_nearby.length > 0 
                ? property.places_nearby.slice(0, 3).join(', ') + (property.places_nearby.length > 3 ? '...' : '')
                : 'Local Amenities Nearby';

            const nearbyHTML = `
                <div class="nearby">
                    <strong>Nearby:</strong>
                    <span>${nearbyPlaces}</span>
                </div>
            `;
            
            // Dynamic Image Loading (Simulated - actual image search call would be needed)
            const imageUrl = property.image || 'https://via.placeholder.com/350x200?text=Property+Image';
            const fallbackImageUrl = await getImageUrl(property.url); // Actual tool usage placeholder

            return `
                <div class="property-card">
                    <div class="property-image-container">
                        <img src="${property.image || fallbackImageUrl}" onerror="this.onerror=null; this.src='${fallbackImageUrl}';" alt="${property.title}" class="property-image">
                        ${badgeText ? `<div class="badge">${badgeText}</div>` : ''}
                    </div>
                    <div class="card-content">
                        <h3 class="property-title">${property.title}</h3>
                        <p class="property-location">${property.location_name}, Noida</p>
                        
                        <div class="price-config">
                            <span class="price">${priceDisplay}</span>
                            <span class="config">${property.config || 'N/A'}</span>
                        </div>

                        <ul class="details-list">
                            <li><strong>Area:</strong> ${property.area || 'N/A'}</li>
                            <li><strong>Furnishing:</strong> ${property.furnishing_details || 'Not Specified'}</li>
                            <li><strong>Available:</strong> ${property.available_from || 'Soon'}</li>
                        </ul>

                        ${featuresHTML}
                        ${nearbyHTML}
                        
                        ${loanDetailsHTML}
                        
                        <div class="action-bar" style="margin-top: 15px; border-top: 1px dashed var(--border-color); padding-top: 10px;">
                             <a href="${property.url || '#'}" target="_blank" style="display: block; text-align: center; background-color: var(--primary-color); color: white; padding: 10px; border-radius: 8px; text-decoration: none; font-weight: 600;">View Details &rarr;</a>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Data Processing ---
        const propertyData = ${JSON.stringify(propertyData)};
        const userConfig = {
            budget: 20000000, // ‚Çπ2 Cr converted to number
            city: 'Noida',
            locality: 'Sector 62',
            type: 'buy',
            recommendation: 'hospitals',
            furnishing: 'semi',
            configuration: '2 BHK'
        };

        // 1. Pre-process Data
        const processedProperties = propertyData
            .map(p => ({
                ...p,
                priceNumeric: parsePrice(p.price),
                isBuy: p.url ? p.url.toLowerCase().includes('sale') : false, // Simple heuristic for Buy/Rent
                configMatch: p.config ? p.config.includes(userConfig.configuration.split(' ')[0]) : false,
                furnishingMatch: p.furnishing_details ? p.furnishing_details.toLowerCase().includes(userConfig.furnishing.toLowerCase()) : false,
                imageIsPresent: p.image !== null && p.image !== ""
            }))
            .filter(p => p.priceNumeric !== Infinity) // Remove properties with unparsable prices
            .filter(p => p.location_name.toLowerCase().includes(userConfig.locality.toLowerCase()))
            .filter(p => p.configMatch);

        // 2. Filter for Under Budget (4 properties)
        let underBudget = processedProperties
            .filter(p => p.priceNumeric <= userConfig.budget)
            .filter(p => p.furnishingMatch)
            .sort((a, b) => a.priceNumeric - b.priceNumeric);

        // Ensure we only take 4 properties that also meet furnishing criteria if possible
        let finalUnderBudget = [];
        let underBudgetAnyFurnish = processedProperties.filter(p => p.priceNumeric <= userConfig.budget).sort((a, b) => a.priceNumeric - b.priceNumeric);
        
        // Try to get 4 matching furnishing first
        const budgetAndFurnish = underBudgetAnyFurnish.filter(p => p.furnishingMatch).slice(0, 4);
        if (budgetAndFurnish.length >= 4) {
            finalUnderBudget = budgetAndFurnish;
        } else {
            // If not enough furnished ones, fill up with any budget matching ones
            finalUnderBudget = budgetAndFurnish;
            const remainingNeeded = 4 - finalUnderBudget.length;
            const remaining = underBudgetAnyFurnish.filter(p => !finalUnderBudget.includes(p)).slice(0, remainingNeeded);
            finalUnderBudget = [...finalUnderBudget, ...remaining];
        }
        finalUnderBudget = finalUnderBudget.slice(0, 4);


        // 3. Filter for Recommended (2 properties) - Based on 'hospitals' nearby
        let recommended = processedProperties
            .filter(p => p.priceNumeric <= userConfig.budget) // Keep budget filter for relevance
            .filter(p => p.places_nearby && p.places_nearby.some(place => place.toLowerCase().includes('hospital') || place.toLowerCase().includes('fortis')));
        
        // Add generic recommendation if not enough specific ones are found
        if (recommended.length < 2) {
            const otherGoodBuys = processedProperties
                .filter(p => !finalUnderBudget.includes(p) && !recommended.includes(p))
                .slice(0, 2 - recommended.length);
            recommended = [...recommended, ...otherGoodBuys];
        }
        
        const finalRecommended = recommended.slice(0, 2);


        // --- Rendering ---
        async function renderProperties() {
            const underBudgetContainer = document.getElementById('under-budget-properties');
            const recommendedContainer = document.getElementById('recommended-properties');
            
            let underBudgetHTML = '';
            for (const prop of finalUnderBudget) {
                underBudgetHTML += await createPropertyCard(prop, 'UNDER BUDGET');
            }
            underBudgetContainer.innerHTML = underBudgetHTML || '<p style="grid-column: 1 / -1; text-align: center; padding: 20px; background: #fff; border-radius: 8px;">No properties found matching your strict budget and furnishing criteria.</p>';

            let recommendedHTML = '';
            for (const prop of finalRecommended) {
                recommendedHTML += await createPropertyCard(prop, 'RECOMMENDED');
            }
            recommendedContainer.innerHTML = recommendedHTML || '<p style="grid-column: 1 / -1; text-align: center; padding: 20px; background: #fff; border-radius: 8px;">No specific recommended properties found. Check the under-budget list!</p>';
        }

        renderProperties();
    </script>
</body>
</html>